# SeaweedFS Filer with S3 API
# Provides file system abstraction and S3-compatible API
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: seaweedfs-filer
  namespace: seaweedfs
spec:
  serviceName: seaweedfs-filer
  replicas: 1
  selector:
    matchLabels:
      app: seaweedfs-filer
  template:
    metadata:
      labels:
        app: seaweedfs-filer
    spec:
      containers:
        - name: filer
          image: chrislusf/seaweedfs:latest
          args:
            - filer
            - -master=seaweedfs-master:9333
            - -ip.bind=0.0.0.0
            - -port=8888
            - -s3
            - -s3.port=8333
            - -s3.config=/etc/seaweedfs/s3.json
            - -defaultReplicaPlacement=000
          ports:
            - containerPort: 8888
              name: filer
            - containerPort: 18888
              name: filer-grpc
            - containerPort: 8333
              name: s3
          env:
            - name: SEAWEEDFS_S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: seaweedfs-s3-secret
                  key: access_key
            - name: SEAWEEDFS_S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: seaweedfs-s3-secret
                  key: secret_key
          volumeMounts:
            - name: data
              mountPath: /data
            - name: s3-config
              mountPath: /etc/seaweedfs
            - name: filer-config
              mountPath: /etc/seaweedfs/filer.toml
              subPath: filer.toml
            - name: ca-bundle
              mountPath: /etc/ssl/certs/ca-certificates.crt
              subPath: ca-certificates.crt
              readOnly: true
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /
              port: 8888
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 8888
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: seaweedfs-filer-data
        - name: s3-config
          configMap:
            name: seaweedfs-s3-config
        - name: filer-config
          configMap:
            name: seaweedfs-filer-config
        - name: ca-bundle
          configMap:
            name: simonellistonball-ca-bundle
---
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-filer
  namespace: seaweedfs
spec:
  type: ClusterIP
  ports:
    - port: 8888
      targetPort: 8888
      name: filer
    - port: 18888
      targetPort: 18888
      name: filer-grpc
    - port: 8333
      targetPort: 8333
      name: s3
  selector:
    app: seaweedfs-filer
---
# Separate service for S3 API
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-s3
  namespace: seaweedfs
spec:
  type: ClusterIP
  ports:
    - port: 8333
      targetPort: 8333
      name: s3
  selector:
    app: seaweedfs-filer
