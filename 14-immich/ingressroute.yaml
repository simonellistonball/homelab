---
# Middleware for large file uploads
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: immich-upload
  namespace: immich
spec:
  buffering:
    maxRequestBodyBytes: 0  # No limit on request body
    maxResponseBodyBytes: 0
    retryExpression: "IsNetworkError() && Attempts() < 2"
---
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: immich-transport
  namespace: immich
spec:
  forwardingTimeouts:
    dialTimeout: 60s
    responseHeaderTimeout: 21600s  # 6 hours for 20GB uploads on slow connections
    idleConnTimeout: 900s  # 15 minutes idle timeout
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: immich
  namespace: immich
spec:
  entryPoints:
    - websecure
  routes:
    - kind: Rule
      match: Host(`immich.apps.house.simonellistonball.com`)
      middlewares:
        - name: immich-upload
      services:
        - name: immich-server
          port: 2283
          serversTransport: immich-transport
  tls:
    secretName: immich-tls
