# kube-prometheus-stack values
# Passwords are substituted by deploy.sh from config.env

# Grafana configuration
grafana:
  adminPassword: GRAFANA_ADMIN_PASSWORD_PLACEHOLDER
  # Disable init-chown-data - files already have correct ownership (472:472)
  # and K3s seccomp blocks chown syscall even for root with CAP_CHOWN
  initChownData:
    enabled: false
  dnsConfig:
    options:
      - name: ndots
        value: "1"
  grafana.ini:
    server:
      root_url: https://grafana.apps.house.simonellistonball.com
  # Mount CA bundle for trusting internal TLS certificates
  extraVolumes:
    - name: ca-bundle
      configMap:
        name: simonellistonball-ca-bundle
  extraVolumeMounts:
    - name: ca-bundle
      mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      readOnly: true
  persistence:
    enabled: true
    size: 5Gi
    storageClassName: local-path
  additionalDataSources:
    - name: Loki
      type: loki
      access: proxy
      url: http://loki.monitoring.svc.cluster.local:3100
      isDefault: false
  sidecar:
    dashboards:
      enabled: true
      searchNamespace: ALL
    datasources:
      enabled: true

# Prometheus configuration
prometheus:
  prometheusSpec:
    retention: 15d
    dnsConfig:
      options:
        - name: ndots
          value: "1"
    # Mount CA bundle for scraping internal HTTPS endpoints
    volumes:
      - name: ca-bundle
        configMap:
          name: simonellistonball-ca-bundle
    volumeMounts:
      - name: ca-bundle
        mountPath: /etc/ssl/certs/ca-certificates.crt
        subPath: ca-certificates.crt
        readOnly: true
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: local-path
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false

# Alertmanager configuration
alertmanager:
  alertmanagerSpec:
    dnsConfig:
      options:
        - name: ndots
          value: "1"
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: local-path
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 5Gi

# Component toggles
kubeStateMetrics:
  enabled: true

nodeExporter:
  enabled: true

# Disable rules for components not in K3s
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false
    kubeProxy: false
    kubeScheduler: false
