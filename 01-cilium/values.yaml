# Cilium CNI Configuration for K3s with IPv6 Dual-Stack
#
# Prerequisites - K3s must be installed with:
#   curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--flannel-backend=none --disable-network-policy --disable=servicelb --disable=traefik" sh -
#
# Documentation: https://docs.cilium.io/en/stable/

# Cluster configuration
cluster:
  name: homelab
  id: 1

# Operator settings
operator:
  replicas: 1

# Enable dual-stack IPv4/IPv6
ipv4:
  enabled: true
ipv6:
  enabled: true

# IPAM configuration for dual-stack
ipam:
  mode: kubernetes
  operator:
    clusterPoolIPv4PodCIDRList:
      - "10.42.0.0/16"
    clusterPoolIPv6PodCIDRList:
      - "fd00:10:42::/48"

# Enable native routing (better performance than tunneling)
routingMode: native
ipv4NativeRoutingCIDR: "10.42.0.0/16"
ipv6NativeRoutingCIDR: "fd00:10:42::/48"
autoDirectNodeRoutes: true

# BPF settings
bpf:
  masquerade: true
  clockProbe: true
  preallocateMaps: true
  tproxy: true
  root: /sys/fs/bpf
  autoMount:
    enabled: true

# Enable Hubble for observability
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true

# K3s specific settings
k8sServiceHost: K8S_NODE_IP_PLACEHOLDER
k8sServicePort: 6443

# Replace kube-proxy with Cilium's eBPF implementation
kubeProxyReplacement: true

# Load balancing settings for services
loadBalancer:
  algorithm: maglev
  mode: snat
  acceleration: native

# L2 announcements - replaces MetalLB
l2announcements:
  enabled: true

# Enable external IPs for LB services
externalIPs:
  enabled: true

# Enable bandwidth manager for better QoS
bandwidthManager:
  enabled: true
  bbr: true

# Security policies
policyEnforcementMode: "default"

# Enable host firewall
hostFirewall:
  enabled: true

# Enable socket-level load balancing
socketLB:
  enabled: true

# BGP control plane (optional, for advanced routing)
bgpControlPlane:
  enabled: false

# Node port configuration
nodePort:
  enabled: true
  range: "30000,32767"

# Enable prometheus metrics
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    labels:
      release: prometheus

# Resource limits
resources:
  limits:
    cpu: 4000m
    memory: 4Gi
  requests:
    cpu: 100m
    memory: 512Mi

# Cilium agent settings
cgroup:
  autoMount:
    enabled: true
  hostRoot: /sys/fs/cgroup

# Enable endpoint health checking
endpointHealthChecking:
  enabled: true

# Well-known identity for kube-dns
wellKnownIdentities:
  enabled: true

# Tolerations for single-node setup
tolerations:
  - operator: Exists

# Update strategy
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1
