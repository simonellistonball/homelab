-- PostgreSQL Setup for Homelab Services
--
-- This template generates SQL to create users and databases.
-- Run generate-postgres-sql.sh to create the actual SQL file with passwords.
--
-- To execute on your PostgreSQL server:
--   sudo -u postgres psql < postgres-setup.sql

-- ============================================
-- Create Users
-- ============================================

-- n8n
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'n8n') THEN
        CREATE ROLE n8n WITH LOGIN PASSWORD '__POSTGRES_N8N_PASSWORD__';
    ELSE
        ALTER USER n8n WITH PASSWORD '__POSTGRES_N8N_PASSWORD__';
    END IF;
END
$$;

-- gitea
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'gitea') THEN
        CREATE ROLE gitea WITH LOGIN PASSWORD '__POSTGRES_GITEA_PASSWORD__';
    ELSE
        ALTER USER gitea WITH PASSWORD '__POSTGRES_GITEA_PASSWORD__';
    END IF;
END
$$;

-- harbor
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'harbor') THEN
        CREATE ROLE harbor WITH LOGIN PASSWORD '__POSTGRES_HARBOR_PASSWORD__';
    ELSE
        ALTER USER harbor WITH PASSWORD '__POSTGRES_HARBOR_PASSWORD__';
    END IF;
END
$$;

-- dagster
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'dagster') THEN
        CREATE ROLE dagster WITH LOGIN PASSWORD '__POSTGRES_DAGSTER_PASSWORD__';
    ELSE
        ALTER USER dagster WITH PASSWORD '__POSTGRES_DAGSTER_PASSWORD__';
    END IF;
END
$$;

-- litellm
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'litellm') THEN
        CREATE ROLE litellm WITH LOGIN PASSWORD '__POSTGRES_LITELLM_PASSWORD__';
    ELSE
        ALTER USER litellm WITH PASSWORD '__POSTGRES_LITELLM_PASSWORD__';
    END IF;
END
$$;

-- immich
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'immich') THEN
        CREATE ROLE immich WITH LOGIN PASSWORD '__POSTGRES_IMMICH_PASSWORD__';
    ELSE
        ALTER USER immich WITH PASSWORD '__POSTGRES_IMMICH_PASSWORD__';
    END IF;
END
$$;

-- frigate
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'frigate') THEN
        CREATE ROLE frigate WITH LOGIN PASSWORD '__POSTGRES_FRIGATE_PASSWORD__';
    ELSE
        ALTER USER frigate WITH PASSWORD '__POSTGRES_FRIGATE_PASSWORD__';
    END IF;
END
$$;

-- ============================================
-- Create Databases
-- ============================================

-- Check and create databases (must be run separately as CREATE DATABASE can't be in transaction)
SELECT 'CREATE DATABASE n8n OWNER n8n' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'n8n')\gexec
SELECT 'CREATE DATABASE gitea OWNER gitea' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'gitea')\gexec
SELECT 'CREATE DATABASE harbor OWNER harbor' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'harbor')\gexec
SELECT 'CREATE DATABASE dagster OWNER dagster' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'dagster')\gexec
SELECT 'CREATE DATABASE litellm OWNER litellm' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'litellm')\gexec
SELECT 'CREATE DATABASE immich OWNER immich' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'immich')\gexec
SELECT 'CREATE DATABASE frigate OWNER frigate' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'frigate')\gexec

-- ============================================
-- Grant Privileges
-- ============================================

GRANT ALL PRIVILEGES ON DATABASE n8n TO n8n;
GRANT ALL PRIVILEGES ON DATABASE gitea TO gitea;
GRANT ALL PRIVILEGES ON DATABASE harbor TO harbor;
GRANT ALL PRIVILEGES ON DATABASE dagster TO dagster;
GRANT ALL PRIVILEGES ON DATABASE litellm TO litellm;
GRANT ALL PRIVILEGES ON DATABASE immich TO immich;
GRANT ALL PRIVILEGES ON DATABASE frigate TO frigate;

-- ============================================
-- Verify
-- ============================================

\echo 'Users created:'
SELECT rolname FROM pg_roles WHERE rolname IN ('n8n', 'gitea', 'harbor', 'dagster', 'litellm', 'immich', 'frigate');

\echo 'Databases created:'
SELECT datname, pg_catalog.pg_get_userbyid(datdba) as owner FROM pg_database WHERE datname IN ('n8n', 'gitea', 'harbor', 'dagster', 'litellm', 'immich', 'frigate');
