# Dagster Helm values
# Passwords are substituted by deploy.sh from config.env

# Global settings for CA trust
global:
  env:
    - name: SSL_CERT_FILE
      value: /etc/ssl/certs/ca-certificates.crt
    - name: REQUESTS_CA_BUNDLE
      value: /etc/ssl/certs/ca-certificates.crt

# Disable bundled PostgreSQL (using external)
postgresql:
  enabled: false
  postgresqlHost: POSTGRES_HOST_PLACEHOLDER
  postgresqlPort: 5432
  postgresqlUsername: dagster
  postgresqlPassword: POSTGRES_DAGSTER_PASSWORD_PLACEHOLDER
  postgresqlDatabase: dagster

# Webserver configuration
dagsterWebserver:
  replicaCount: 1
  dnsConfig:
    options:
      - name: ndots
        value: "1"
  volumes:
    - name: ca-bundle
      configMap:
        name: simonellistonball-ca-bundle
  volumeMounts:
    - name: ca-bundle
      mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      readOnly: true

# Daemon configuration
dagsterDaemon:
  enabled: true
  dnsConfig:
    options:
      - name: ndots
        value: "1"
  volumes:
    - name: ca-bundle
      configMap:
        name: simonellistonball-ca-bundle
  volumeMounts:
    - name: ca-bundle
      mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      readOnly: true

# Ingress disabled - using Traefik IngressRoute
ingress:
  enabled: false

# User code deployments
dagster-user-deployments:
  enabled: true
  enableSubchart: true
  deployments:
    - name: osm-pipeline
      image:
        repository: harbor.apps.house.simonellistonball.com/dagster/osm-pipeline
        tag: latest
        pullPolicy: Always
      dagsterApiGrpcArgs:
        - "-m"
        - "osm_pipeline.definitions"
      port: 4000
      includeConfigInLaunchedRuns:
        enabled: true
      envConfigMaps:
        - name: osm-pipeline-storage-config
      envSecrets:
        - name: osm-pipeline-postgres-secret
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
      # Use the existing harbor-pull secret for pulling images
      imagePullSecrets:
        - name: harbor-pull
      # Volume mounts for run pods (inherited via includeConfigInLaunchedRuns)
      volumes:
        - name: osm-downloads
          persistentVolumeClaim:
            claimName: osm-downloads-pvc
        - name: osm-temp
          persistentVolumeClaim:
            claimName: osm-temp-pvc
        - name: osm-scratch
          persistentVolumeClaim:
            claimName: osm-scratch-pvc
        - name: osm-output
          persistentVolumeClaim:
            claimName: osm-output-pvc
        - name: ca-bundle
          configMap:
            name: simonellistonball-ca-bundle
        # Direct NFS mounts for shared data access
        - name: nfs-data
          nfs:
            server: TRUENAS_IP_PLACEHOLDER
            path: /mnt/data/data
        - name: nfs-archives
          nfs:
            server: TRUENAS_IP_PLACEHOLDER
            path: /mnt/data/archive
      volumeMounts:
        - name: osm-downloads
          mountPath: /data/downloads
        - name: osm-temp
          mountPath: /data/tmp
        - name: osm-scratch
          mountPath: /data/scratch
        - name: osm-output
          mountPath: /data/output
        - name: ca-bundle
          mountPath: /etc/ssl/certs/ca-certificates.crt
          subPath: ca-certificates.crt
          readOnly: true
        # Shared NFS data mounts
        - name: nfs-data
          mountPath: /mnt/data/data
        - name: nfs-archives
          mountPath: /mnt/data/archive
      dnsConfig:
        options:
          - name: ndots
            value: "1"
      env:
        - name: SSL_CERT_FILE
          value: /etc/ssl/certs/ca-certificates.crt
        - name: REQUESTS_CA_BUNDLE
          value: /etc/ssl/certs/ca-certificates.crt
    - name: serendipity
      image:
        repository: harbor.apps.house.simonellistonball.com/dagster/serendipity
        tag: latest
        pullPolicy: Always
      dagsterApiGrpcArgs:
        - "-m"
        - "dagster_pipelines"
      port: 4000
      includeConfigInLaunchedRuns:
        enabled: true
      envConfigMaps:
        - name: serendipity-storage-config
      envSecrets:
        - name: serendipity-postgres-secret
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
      imagePullSecrets:
        - name: harbor-pull
      volumes:
        - name: ca-bundle
          configMap:
            name: simonellistonball-ca-bundle
        - name: nfs-data
          nfs:
            server: TRUENAS_IP_PLACEHOLDER
            path: /mnt/data/data
      volumeMounts:
        - name: ca-bundle
          mountPath: /etc/ssl/certs/ca-certificates.crt
          subPath: ca-certificates.crt
          readOnly: true
        - name: nfs-data
          mountPath: /mnt/data/data
      dnsConfig:
        options:
          - name: ndots
            value: "1"
      env:
        - name: SSL_CERT_FILE
          value: /etc/ssl/certs/ca-certificates.crt
        - name: REQUESTS_CA_BUNDLE
          value: /etc/ssl/certs/ca-certificates.crt
