# Dagster Helm values
# Passwords are substituted by deploy.sh from config.env

# Global settings for CA trust
global:
  env:
    - name: SSL_CERT_FILE
      value: /etc/ssl/certs/ca-certificates.crt
    - name: REQUESTS_CA_BUNDLE
      value: /etc/ssl/certs/ca-certificates.crt

# Disable bundled PostgreSQL (using external)
postgresql:
  enabled: false
  postgresqlHost: POSTGRES_HOST_PLACEHOLDER
  postgresqlPort: 5432
  postgresqlUsername: dagster
  postgresqlPassword: POSTGRES_DAGSTER_PASSWORD_PLACEHOLDER
  postgresqlDatabase: dagster

# Webserver configuration
dagsterWebserver:
  replicaCount: 1
  dnsConfig:
    options:
      - name: ndots
        value: "1"
  volumes:
    - name: ca-bundle
      configMap:
        name: simonellistonball-ca-bundle
  volumeMounts:
    - name: ca-bundle
      mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      readOnly: true

# Daemon configuration
dagsterDaemon:
  enabled: true
  dnsConfig:
    options:
      - name: ndots
        value: "1"
  volumes:
    - name: ca-bundle
      configMap:
        name: simonellistonball-ca-bundle
  volumeMounts:
    - name: ca-bundle
      mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      readOnly: true

# Ingress disabled - using Traefik IngressRoute
ingress:
  enabled: false

# User code deployments (example - customize as needed)
dagster-user-deployments:
  enabled: true
  enableSubchart: true
  deployments:
    - name: osm-pipeline
      image:
        repository: harbor.apps.house.simonellistonball.com/dagster/osm-pipeline
        tag: latest
        pullPolicy: Always
      imagePullSecrets:
        - name: harbor-pull
      dagsterApiGrpcArgs:
        - "-m"
        - "osm_pipeline.definitions"
      port: 4000
      includeConfigInLaunchedRuns:
        enabled: true
      envConfigMaps:
        - name: osm-pipeline-storage-config
      envSecrets:
        - name: osm-pipeline-postgres-secret
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 256Mi
      volumes:
        - name: ca-bundle
          configMap:
            name: simonellistonball-ca-bundle
      volumeMounts:
        - name: ca-bundle
          mountPath: /etc/ssl/certs/ca-certificates.crt
          subPath: ca-certificates.crt
          readOnly: true
      dnsConfig:
        options:
          - name: ndots
            value: "1"
      env:
        - name: SSL_CERT_FILE
          value: /etc/ssl/certs/ca-certificates.crt
        - name: REQUESTS_CA_BUNDLE
          value: /etc/ssl/certs/ca-certificates.crt
